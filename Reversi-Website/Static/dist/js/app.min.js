"use strict";var SPA=function(){var t=void 0,n="logged-in",i=function(e){e.preventDefault();return Reversi.startNewGame(0)},e={currentUser:null,init:function(){t=new EventModule.EventEmitter,e.events.login=new EventModule.EventSubscriber(n,t),SPA.Data.init();var r=document.getElementById("content");return r.innerHTML=SPA_Templates.login.login({messageModel:{hasMessage:!1,message:""}}),e.events.login.subscribe(function(){var e=SPA_Templates.reversi["lobby-list"]({lobbies:[]}),t=SPA_Templates.reversi["game-board"]({});r.innerHTML=SPA_Templates.reversi["game-screen"]({lobbyList:e,gameBoard:t});var n=document.getElementById("game-board");Reversi.init(n),document.getElementById("new-game-button").addEventListener("click",i),Reversi.reloadLobbies(),SPA.Data.lobbyJoined.subscribe(Reversi.initCurrentGame),SPA.Data.serverEvents["move-made"].subscribe(function(){FeedbackWidget.createNotification("positive","move made").display()})}),!0},login:function(e){SPA.Data.login(e).then(function(){return t.emit(n)})},events:{login:null}};return e}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};SPA.Data=function(){var n,r,i,o,c,s,a=function(n){var r=[];return Object.keys(n).map(function(e){e=encodeURIComponent(e);var t=encodeURIComponent(n[e]);r.push(e+"="+t)}),r.join("&")},u="http://localhost:5000",l=void 0,t={lobbyOpened:"lobby-opened",lobbyJoined:"lobby-joined"},d=void 0,f=(i=r=!(n=[]),o=function(){i=!0},c=function(){i=!1},s=function(){r=!0;var e=function(){return(e="http://localhost:5000/api/session/updates",window.fetch(e,{headers:{Connection:"Keep-Alive","session-id":d}})).then(function(e){return e.ok?e.json():Promise.reject()}).then(function(e){if(!(e instanceof Array))return Promise.reject("Invalid data type: "+(void 0===e?"undefined":_typeof(e)));e.forEach(function(e){e=e.toString(),Object.keys(n).includes(e)?l.emit(n[e]):console.log("Unknown update code "+e)}),e!==[]&&console.log(e)}).catch(function(e){return console.log(e)});var e},t=Promise.resolve(!0);setInterval(function(){i||(t=t.then(function(){e()}))},500)},{init:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;e=null!=e?e:new EventModule.EventEmitter,Object.keys(t).forEach(function(e){return f.watch(Number(e),t[e])}),window.addEventListener("blur",o),window.addEventListener("focus",c)},watch:function(e,t){if(Object.keys(n).includes(e.toString()))throw new Error("Update-code "+e.toString()+" already has event "+n[e.toString()]+" assigned");n[e]=t,r||s()},subscribe:function(e,t){return l.subscribe(e,t)},unsubscribe:function(e,t){return l.unsubscribe(e,t)}}),v={API_HOST:u,init:function(){l=new EventModule.EventEmitter,Object.keys(t).forEach(function(e){return v[e]=new EventModule.EventSubscriber(t[e],l)});var e={0:"move-made",1:"game-players-updated",2:"lobby-users-updated",3:"lobby-game-updated"};window.fetch(u+"/api/session",{method:"GET",mode:"cors"}).then(function(e){return e.json()}).then(function(e){return Promise.resolve(e.sessionId)}).then(function(e){return d=e}).then(function(){f.init(e,l)}),v.serverEvents={},Object.values(e).forEach(function(e){v.serverEvents[e]=new EventModule.EventSubscriber(e,l)})},login:function(t){var e=a(t);return window.fetch(u+"/api/login",{method:"POST",body:e,headers:{"session-id":d},mode:"cors"}).then(function(e){return SPA.currentUser=new SPA.User(t.Username),e.ok?e.text():Promise.reject()})},makeMove:function(e,t){var n={FromX:Number(e.x),FromY:Number(e.y),ToX:Number(t.x),ToY:Number(t.y)},r=new Headers({"Content-Type":"application/x-www-form-urlencoded","session-id":d});return window.fetch(u+"/api/move",{method:"POST",mode:"cors",body:a(n),headers:r}).then(function(e){return e.ok?Promise.resolve():Promise.reject()})},fetchScenarioIds:function(){return window.fetch(u+"/api/scenario",{method:"GET",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.body.getReader().read().then(function(e){var t=e;return null==t?Promise.reject():Promise.resolve(t)})})},fetchLobby:function(e){return window.fetch(u+"/api/lobbies/"+e,{method:"GET",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.body.getReader().read().then(function(e){var t=e;return null==t?Promise.reject():Promise.resolve(t)})})},fetchLobbies:function(){return window.fetch(u+"/api/lobbies",{method:"GET",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.json()})},openLobby:function(){return window.fetch(u+"/api/lobbies",{method:"POST",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded","session-id":d}}).then(function(e){return e.ok?(l.emit(t.lobbyOpened),Promise.resolve(e)):Promise.reject()})},joinLobby:function(e){return window.fetch(u+"/api/lobbies/"+e,{method:"POST",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded","session-id":d}}).then(function(e){return e.ok?e.json():Promise.reject()}).then(function(e){return Reversi.setPlayerColour(e.colour),l.emit(t.lobbyJoined),e})},pieceAPI:{getPieceCoordinates:function(){var e;return(e=new Headers({"session-id":d}),window.fetch(u+"/api/board",{method:"GET",mode:"cors",headers:e})).then(function(e){return e.body.getReader().read().then(function(e){var t=JSON.parse(new TextDecoder("utf-8").decode(e.value)),n=[];return t.pieces.forEach(function(e){Object.keys(n).includes(e.colour)||(n[e.colour]=[]),n[e.colour].push(new Reversi.Coords(e.position.x,e.position.y))}),Promise.resolve(n)})})}},fetchCurrentGame:function(){return window.fetch(u+"/api/game",{method:"GET",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded","session-id":d}}).then(function(e){return e.ok?e.json():Promise.reject()}).then(function(e){return new SPA.Data.GameDTO(e)})},gameAPI:{startNewGame:function(e){var t=encodeURIComponent(e);return window.fetch(u+"/api/game",{method:"POST",mode:"cors",body:t,headers:{"Content-Type":"application/x-www-form-urlencoded","session-id":d}}).then(function(e){return e.ok?e.json():Promise.reject()}).then(function(e){return Reversi.setPlayerColour(e.colour)})}}};return v}();var EventModule={},FeedbackWidget=function(){var c,i=void 0,o=(c="FeedbackWidget-messages",{store:function(e){var t=window.localStorage,n=t.getItem(c),r=null!=n?JSON.parse(n):[],i=[];for(i.push(e);0<r.length&&!(10<=i.length);){var o=r.shift();i.push(o)}t.setItem(c,JSON.stringify(i))},clear:function(){var e=window.localStorage;null!=e.getItem(c)&&e.removeItem(c)}}),s={create:function(e){var t=void 0;switch(e.type){case"positive":t="feedback-widget-positive";break;case"negative":t="feedback-widget-negative";break;default:case"neutral":t="feedback-widget-neutral"}var n=document.createElement("div");n.classList.add("feedback-widget",t);var r=document.createElement("span");r.classList.add("feedback-widget-title"),r.innerHTML=e.title,n.appendChild(r);var i=document.createElement("span");i.classList.add("feedback-widget-content"),i.innerHTML=e.content,n.appendChild(i);var o,c=((o=document.createElement("span")).innerHTML="&#10761;",Object.assign(o.style,{position:"absolute",right:"10px",top:"10px",width:"15px",height:"15px",textAlign:"center",lineHeight:"15px",fontSize:"15px",border:"1px solid black",borderRadius:"15px",cursor:"pointer",backgroundColor:"#E6E6E6"}),o);return c.addEventListener("click",function(){null!=e.close&&e.close()}),n.appendChild(c),n},createButton:function(e){var t=document.createElement("button"),n="event-click",r=new EventModule.EventEmitter,i=new EventModule.EventSubscriber(n,r);return t.innerText=e,t.addEventListener("click",function(){r.emit(n)}),{clicked:i,element:t}}};return{createNotification:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",r=new FeedbackWidget.Notification(e,t,n);return r.element=s.create(r),r.displayed.subscribe(function(){o.store(r)}),r.addButton=function(e){var t=s.createButton(e);return r.element.appendChild(t.element),t.clicked},r.displayTarget=i,r},init:function(e){return i=e,!0}}}(),Reversi=function(){var n=void 0,o=void 0,c=void 0,s="move-made",e=function(e){var t,n=o,r=new Reversi.Scenario(e.Board.Size),i=Reversi.GameFactory.fromScenario(r);return i.addPlayer(n),t=i,Reversi.events.moveMade.subscribe(t.updateState),n.onSelectionChanged.subscribe(t.view.update),t.stateUpdated.subscribe(function(){Object.values(t.board.cells).forEach(function(e){e.onRightClick=function(){n.ownsPiece(n.selectedPiece)&&SPA.Data.makeMove(n.selectedPiece.position,e.coords).then(function(){return c.emit(s)}).then(Reversi.Feedback.move_success).catch(Reversi.Feedback.move_failure)}}),t.pieces.forEach(function(e){return e.onClick.subscribe(function(){return n.selectPiece(e)})})}),t.stateUpdated.subscribe(t.view.update),SPA.Data.serverEvents["move-made"].subscribe(function(){return t.updateState()}),i.updateState().then(function(){return i})},t=function(e){for(;null!=n.firstChild;)n.removeChild(n.firstChild);var t=e.view;n.appendChild(t.element),t.render()},r=function(){SPA.Data.fetchCurrentGame().then(e).then(t)},i={init:function(e){Reversi.GameFactory.init(),c=new EventModule.EventEmitter,i.events={moveMade:new EventModule.EventSubscriber(s,c)},n=e},initCurrentGame:r,startNewGame:function(e){return SPA.Data.openLobby().then(function(){return SPA.Data.gameAPI.startNewGame(e)}).then(r)},setPlayerColour:function(e){null==o&&(o=new Reversi.Player(SPA.currentUser.username,e))},reloadLobbies:function(){var t=document.getElementById("lobby-list");SPA.Data.fetchLobbies().then(function(e){return t.innerHTML=SPA_Templates.reversi["lobby-list"]({lobbies:e})})}};return i}();SPA.User=function(e){this.username=e},SPA.Data.BoardDTO=function(e){this.Size=Reversi.Size.parse(e.size),this.Pieces=e.pieces},SPA.Data.GameDTO=function(e){this.Board=new SPA.Data.BoardDTO(e.boardInfo),this.Players=e.players,this.Moves=e.moves,this.CurrentPlayer=e.currentPlayer},SPA.Data.PlayerDTO=function(e){this.Colour=e.colour,this.Score=e.score},SPA.Data.PlayerDTO.toPlayer=function(){return new Reversi.Player(this.Colour,this.Colour)},EventModule.EventEmitter=function(){var r=[];this.subscribe=function(e,t){Object.keys(r).includes(e)||(r[e]=[]),r[e].push(t)},this.unsubscribe=function(e,t){if(Object.keys(r).includes(e)&&r[e].includes(t)){var n=r[e];n.splice(n.indexOf(t),1),r[e]=n}},this.emit=function(e){Object.keys(r).includes(e)&&r[e].forEach(function(e){return e.call()})}},EventModule.EventSubscriber=function(t,n){this.subscribe=function(e){return n.subscribe(t,e)},this.unsubscribe=function(e){return n.unsubscribe(t,e)}},FeedbackWidget.Coords=function(e,t){this.x=e,this.y=t,this.toString=function(){return e+", "+t}},FeedbackWidget.Coords.parse=function(e){var t=e.split(","),n=2===t.length,r=!0;if(t.map(function(e){e=e.trim(),isNaN(Number(e))&&(r=!1)}),!n||!r)throw new Error("Incorrect input: "+e);var i=Number(t[0]),o=Number(t[1]);return new FeedbackWidget.Coords(i,o)},FeedbackWidget.Notification=function(e,t,n){var r=this;switch(e){case"positive":case"negative":this.type=e;break;default:case"neutral":this.type="neutral"}var i=new EventModule.EventEmitter,o="event-displayed";this.displayed=new EventModule.EventSubscriber(o,i),this.title=t,this.content=n,this.close=function(){null!=r.element&&null!=r.element.parentNode&&(r.element.parentNode.removeChild(r.element),r.displayData.coords=null)},this.display=function(e,t){var n=new FeedbackWidget.Coords(e,t);if(r.displayData.coords=n,null==r.element)throw new Error("element is null");if(Object.assign(r.element.style,{position:"sticky",left:n.x+"px",top:n.y+"px"}),i.emit(o),null==r.displayTarget)throw new Error("displayTarget is null or undefined");return r.displayTarget.appendChild(r.element),r.element},this.isShown=function(){return null!=this.displayData.coords},this.element=null,this.displayTarget=null,this.displayData={coords:null},this.addButton=null},Reversi.BoardFactory=function(a){this.createBoard=function(e,t){for(var n=[],r=0;r<t;r++){for(var i=[],o=0;o<e;o++){var c=new Reversi.Coords(r,o);i[o]=a.createCell(c)}n[r]=i}var s=[];return n.forEach(function(e){return e.forEach(function(e){return s[e.coords.toString()]=e})}),new Reversi.Board(new Reversi.Size(e,t),s)}},Reversi.Board=function(e,t){this.width=e.x,this.height=e.y,this.cells=t},Reversi.CellFactory=function(){this.createCell=function(e){var t=(e.x+e.y)%2==1?"red":"brown";return new Reversi.Cell(e,t)}},Reversi.Cell=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;this.coords=e,this.colour=t,this.occupant=n,this.onClick=null,this.onRightClick=null},Reversi.Coords=function(e,t){this.x=e,this.y=t,this.toString=function(){return e+", "+t}},Reversi.Coords.parse=function(e){var t=e.split(","),n=2===t.length,r=!0;if(t.map(function(e){e=e.trim(),isNaN(Number(e))&&(r=!1)}),!n||!r)throw new Error("Incorrect input: "+e);var i=Number(t[0]),o=Number(t[1]);return new Reversi.Coords(i,o)},Reversi.Size=function(e,t){var n=this;this.x=e,this.y=t,this.getArea=function(){return n.x*n.y}},Reversi.Size.parse=function(e){var t=e.split(","),n=Number(t[0].replace(new RegExp("[^0-9]"),"")),r=Number(t[1].replace(new RegExp("[^0-9]"),""));return new Reversi.Size(n,r)},Reversi.PieceFactory=function(e){var t=this;if(null==e)throw new Error("colour cannot be null");if(!(e=e.replace("#","")).match(/^[0-9A-F]{6}$/))throw new Error("Invalid hex colour code");this.colour="#"+e,this.createPiece=function(){return new Reversi.Piece(t.colour)}},Reversi.Piece=function(e){var t=this,n=new EventModule.EventEmitter,r="click-left";this.colour=e,this.position=null,this.onClick=new EventModule.EventSubscriber(r,n),this.click=function(){n.emit(r)},this.isSelected=!1,this.select=function(){t.isSelected=!0},this.deselect=function(){t.isSelected=!1},this.toggleSelect=function(){t.isSelected=!t.isSelected}},Reversi.Piece.Colours={BLACK:"#000000",WHITE:"#FFFFFF"},Reversi.Feedback=function(){var r="positive",i="negative",e=function(e){var t=e?"Zet gezet!":"Zet niet gezet: er is iets misgegaan...",n=e?r:i;FeedbackWidget.createNotification(n,t)};return{move_success:function(){return e(!0)},move_failure:function(){return e(!1)}}}(),Reversi.GameFactory=function(){var n=void 0,e=void 0,t=function(e){var t=n.createBoard(e.x,e.y);return new Reversi.Game(t)};return{init:function(){return e=new Reversi.CellFactory,n=new Reversi.BoardFactory(e),!0},fromScenario:function(e){return t(e.boardSize)},fromSize:t}}(),Reversi.Game=function(e){var r=this,t=new EventModule.EventEmitter,n="state-updated";this.stateUpdated=new EventModule.EventSubscriber(n,t),this.updateState=function(){return SPA.Data.pieceAPI.getPieceCoordinates().then(function(r){var i=[];return Object.keys(r).forEach(function(e){var n=new Reversi.PieceFactory(e),t=r[e];i.concat(t.forEach(function(e){var t=n.createPiece();t.position=e,i.push(t)}))}),i}).then(r.setPieces).then(function(){return t.emit(n)})};this.setPieces=function(e){!function(){for(;0<r.pieces.length;){var e=r.pieces.shift();r.despawnPiece(e)}}(),e.forEach(function(e){return r.spawnPiece(e,e.position)})},this.addPlayer=function(t){if(t.colour in r.players)throw new Error(t.colour+" already exists");r.players[t.colour()]=t,r.pieces.filter(function(e){return e.colour===t.colour()}).forEach(function(e){return t.pieces.push(e)})},this.getPlayerPieces=function(t){return r.pieces.filter(function(e){return e.colour===t.colour()})},this.spawnPiece=function(e,t){if(null==e||null==t)throw new Error("Invalid input");var n=r.board.cells[t];if(null!=n.occupant)throw new Error("Cell already occupied");e.position=t,n.occupant=e,r.pieces.push(e)},this.despawnPiece=function(e){r.board.cells[e.position].occupant=null,r.pieces.includes(e)&&r.pieces.splice(r.pieces.indexOf(e),1)},this.pieces=[],this.board=e,this.players=[],this.view=new Reversi.BoardSVG(this)},Reversi.Player=function(e,t){var n=this,r=new EventModule.EventEmitter,i="selection-changed";this.username=e,this.pieces=[];var o=t;this.colour=function(){return o},this.onSelectionChanged=new EventModule.EventSubscriber(i,r),this.selectPiece=function(e){n.deselectPiece(),(n.selectedPiece=e).select(),r.emit(i)},this.deselectPiece=function(){null!=n.selectedPiece&&(n.selectedPiece.deselect(),n.selectedPiece=null,r.emit(i))},this.ownsPiece=function(e){if(null==e)return!1;var t=function(e){return e.replace("#","")};return t(n.colour())===t(e.colour)}},Reversi.Scenario=function(e){var n=this;this.addPiece=function(e,t){null==n.startingPiecesCoords[e]&&(n.startingPiecesCoords[e]=[]),n.startingPiecesCoords[e].push(t)},this.addPlayer=function(e,t){n.players[t]=e},this.boardSize=e,this.startingPiecesCoords=[],this.players=[]},Reversi.BoardSVG=function(e){var r=this,t=new EventModule.EventEmitter,n="update",i=new Reversi.BoardElementFactory;this.element=i.createBoardElement(e.board.width,e.board.height,e.board.cells),this.pieces=[],this.cells=[],this.model=e,this.renderPiece=function(e){var t=e.position,n=i.createPieceElement(e);r.pieces[t]=n,r.element.appendChild(n)};var o=function(e){var t=i.createCellElement(e);r.cells[e.coords]=t,r.element.appendChild(t)};this.clear=function(){Object.keys(r.pieces).forEach(function(e){return r.element.removeChild(r.pieces[e])}),r.pieces=[]},this.render=function(){var t=[];Object.keys(r.model.board.cells).forEach(function(e){return t.push(r.model.board.cells[e])}),t.forEach(o),r.update()},this.updateInvoked=new EventModule.EventSubscriber(n,t),this.update=function(){r.clear(),r.model.pieces.forEach(r.renderPiece),t.emit(n)}},Reversi.BoardElementFactory=function(){var c=this,s="http://www.w3.org/2000/svg";this.createPieceElement=function(t){var e=document.createElementNS(s,"circle"),n=new Reversi.Coords(t.position.x+.5,t.position.y+.5),r={r:4,style:"fill:"+t.colour,cx:10*n.x,cy:10*n.y};switch(t.colour){case Reversi.Piece.Colours.BLACK:"reversi-piece-black";break;case Reversi.Piece.Colours.WHITE:"reversi-piece-white";break;default:throw new Error("Unknown colour "+t.colour)}return e.addEventListener("click",function(e){e.preventDefault(),t.click()}),e.classList.add("reversi-piece"),t.isSelected&&(r["stroke-width"]=".5",r.stroke="white"),Reversi.BoardElementFactory.SVGUtil.setAttributesNS(e,r),e},this.createCellElement=function(t){var e=document.createElementNS(s,"rect"),n={x:10*t.coords.x,y:10*t.coords.y,width:10,height:10,style:"fill:"+t.colour};return Reversi.BoardElementFactory.SVGUtil.setAttributesNS(e,n),e.addEventListener("click",function(e){e.preventDefault(),null!=t.onClick&&t.onClick()}),e.classList.add("reversi-board-cell"),e.addEventListener("contextmenu",function(e){e.preventDefault(),null!=t.onRightClick&&t.onRightClick()}),e},this.createBoardElement=function(e,t,n){var r=document.createElementNS(s,"svg");n.map(function(e){var t=c.createCellElement(e);r.appendChild(t)});var i=10*e,o=10*t;return Reversi.BoardElementFactory.SVGUtil.setAttributesNS(r,{viewBox:"0 0 "+i+" "+o}),r}},Reversi.BoardElementFactory.SVGUtil=function(){var r=function(t){if(!(t instanceof Object))throw new Error("target not an Object");var n=[];return Object.keys(t).map(function(e){n[e]=t[e]}),n};return{objectToArray:r,setAttributesNS:function(e,t){if(!(e instanceof Element))throw new Error("target not an HTMLElement");if(t instanceof Object&&(t=r(t)),!(t instanceof Array))throw new Error("target not an Array");for(var n in t)e.setAttribute(n,t[n])}}}();