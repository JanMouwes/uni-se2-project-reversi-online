"use strict";var Reversi=function(){var i=void 0,o=void 0,c=function(e){var t,n=o,r=GameFactory.fromScenario(e);return r.addPlayer(n),t=r,Reversi.Data.moveMade.subscribe(t.updateState),n.onSelectionChanged.subscribe(t.view.update),t.stateUpdated.subscribe(function(){Object.values(t.board.cells).forEach(function(e){e.onRightClick=function(){n.ownsPiece(n.selectedPiece)&&Reversi.Data.makeMove(n.selectedPiece.position,e.coords)}}),t.pieces.forEach(function(e){return e.onClick.subscribe(function(){return n.selectPiece(e)})})}),t.stateUpdated.subscribe(t.view.update),r.updateState().then(function(){return r})},s=function(e){e.preventDefault();var t=Number(document.getElementById("scenario-selector").value);return Reversi.Data.openLobby().then(function(){return Reversi.Data.gameAPI.startNewGame(t)}).then(Reversi.Data.fetchScenario).then(c).then(a)},a=function(e){for(;null!=i.firstChild;)i.removeChild(i.firstChild);var t=e.view;i.appendChild(t.element),t.render()},u=function(){var i=document.getElementById("lobby-list"),t=function(e){var t,n,r=(t=e,(n=document.createElement("li")).innerText="Id: "+t.id,n);r.onclick=function(){return Reversi.Data.joinLobby(e.id)},i.appendChild(r)};Reversi.Data.fetchLobbies().then(function(e){return e.forEach(t)})};return{init:function(e){Reversi.Data.init(),Reversi.LongPollDevice.init(),i=e;for(var t=prompt("What is your name?"),n=void 0;!(n=prompt("What colour do you want to be? Hex pls","FFFFFF")).match(/^[0-9A-F]{6}$/););var r=new Reversi.Player(t,"#".concat(n));o=r,document.getElementById("scenario-form").addEventListener("submit",s),u(),Reversi.Data.lobbyJoined.subscribe(function(){Reversi.Data.fetchCurrentGame().then(function(e){var t=Reversi.Size.parse(e.boardInfo.size);return new Reversi.Scenario(t)}).then(c).then(a)})}}}(),FeedbackWidget=function(){var e=document.currentScript.src,n="feedback-widget-css",r=e+"/.."+"/../assets/feedback-widget.css";return{createNotification:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",s=e,a=t,u=n,d=function(){null!=(void 0).element&&(void 0).element.parentNode.removeChild((void 0).element)};return{feedbackType:s,title:a,content:u,coords:[0,0],element:null,close:d,display:function(e,t){return(void 0).coords=[e,t],(void 0).element=function(){var e=void 0;switch(s){case"positive":e="feedback-widget-positive";break;case"negative":e="feedback-widget-negative";break;default:case"neutral":e="feedback-widget-neutral"}var t=(void 0).coords[0],n=(void 0).coords[1],r=document.createElement("div");r.classList.add("feedback-widget",e),Object.assign(r.style,{position:"sticky",left:t+"px",top:n+"px"});var i=document.createElement("span");i.classList.add("feedback-widget-title"),i.innerHTML=a,r.appendChild(i);var o=document.createElement("span");o.classList.add("feedback-widget-content"),o.innerHTML=u,r.appendChild(o);var c=document.createElement("span");return c.innerHTML="&#10761;",Object.assign(c.style,{position:"absolute",right:"10px",top:"10px",width:"15px",height:"15px",textAlign:"center",lineHeight:"15px",fontSize:"15px",border:"1px solid black",borderRadius:"15px",cursor:"pointer",backgroundColor:"#E6E6E6"}),c.addEventListener("click",d),r.appendChild(c),r}(),(void 0).element}}},init:function(){if(null!=document.getElementById(n))return!0;var e=document.getElementsByTagName("head")[0],t=document.createElement("link");return t.id=n,t.rel="stylesheet",t.type="text/css",t.href=r,e.appendChild(t),!0}}}();Reversi.BoardFactory=function(a){this.createBoard=function(e,t){for(var n=[],r=0;r<t;r++){for(var i=[],o=0;o<e;o++){var c=new Reversi.Coords(r,o);i[o]=a.createCell(c)}n[r]=i}var s=[];return n.forEach(function(e){return e.forEach(function(e){return s[e.coords.toString()]=e})}),new Reversi.Board(new Reversi.Size(e,t),s)}},Reversi.Board=function(e,t){this.width=e.x,this.height=e.y,this.cells=t},Reversi.CellFactory=function(){this.createCell=function(e){var t=(e.x+e.y)%2==1?"red":"brown";return new Reversi.Cell(e,t)}},Reversi.Cell=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;this.coords=e,this.colour=t,this.occupant=n,this.onClick=null,this.onRightClick=null},Reversi.Coords=function(e,t){this.x=e,this.y=t,this.toString=function(){return e+", "+t}},Reversi.Coords.parse=function(e){var t=e.split(","),n=2===t.length,r=!0;if(t.map(function(e){e=e.trim(),isNaN(Number(e))&&(r=!1)}),!n||!r)throw new Error("Incorrect input: "+e);var i=Number(t[0]),o=Number(t[1]);return new Reversi.Coords(i,o)},Reversi.Size=function(e,t){var n=this;this.x=e,this.y=t,this.getArea=function(){return n.x*n.y}},Reversi.Size.parse=function(e){var t=e.split(","),n=Number(t[0].replace(new RegExp("[^0-9]"),"")),r=Number(t[1].replace(new RegExp("[^0-9]"),""));return new Reversi.Size(n,r)},Reversi.PieceFactory=function(e){var t=this;if(null==e)throw new Error("colour cannot be null");if(!(e=e.replace("#","")).match(/^[0-9A-F]{6}$/))throw new Error("Invalid hex colour code");this.colour="#".concat(e),this.createPiece=function(){return new Reversi.Piece(t.colour)}},Reversi.Piece=function(e){var t=this,n=new Reversi.EventEmitter,r="click-left";this.colour=e,this.position=null,this.onClick=new Reversi.EventSubscriber(r,n),this.click=function(){n.emit(r)},this.isSelected=!1,this.select=function(){t.isSelected=!0},this.deselect=function(){t.isSelected=!1},this.toggleSelect=function(){t.isSelected=!t.isSelected}},Reversi.Data=function(){var c="http://localhost:5000",s=void 0,a="move-made",t="lobby-opened",n="lobby-joined",u=void 0,e={API_HOST:c,init:function(){s=new Reversi.EventEmitter,e.moveMade=new Reversi.EventSubscriber(a,s),e.lobbyOpened=new Reversi.EventSubscriber(t,s),e.lobbyJoined=new Reversi.EventSubscriber(n,s),window.fetch(c+"/api/session",{method:"GET",mode:"cors"}).then(function(e){return e.json()}).then(function(e){return Promise.resolve(e.sessionId)}).then(function(e){return u=e})},makeMove:function(e,t){var n,r,i={FromX:Number(e.x),FromY:Number(e.y),ToX:Number(t.x),ToY:Number(t.y)},o=new Headers({"Content-Type":"application/x-www-form-urlencoded","session-id":u});return window.fetch(c+"/api/move",{method:"POST",mode:"cors",body:(n=i,r=[],Object.keys(n).map(function(e){e=encodeURIComponent(e);var t=encodeURIComponent(n[e]);r.push(e+"="+t)}),r.join("&")),headers:o}).then(function(e){return e.ok?Promise.resolve():Promise.reject()}).then(function(){return s.emit(a)})},fetchScenario:function(e){if(isNaN(e))throw new Error("Invalid input");e=Number(e);return window.fetch(c+"/api/scenario/"+e,{method:"GET",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.body.getReader().read().then(function(e){var t,r,n,i,o=(t=e,r=JSON.parse(new TextDecoder("utf-8").decode(t.value)),n=Reversi.Size.parse(r.boardSize),i=new Reversi.Scenario(n),Object.keys(r.startingPositions).map(function(e){var t=r.startingPositions[e];t="#"===t.split()[0]?t:"#".concat(t),e=e.replace("(","").replace(")","");var n=Reversi.Coords.parse(e);i.addPiece(t,n)}),i);return null==o?Promise.reject():Promise.resolve(o)})})},fetchScenarioIds:function(){return window.fetch(c+"/api/scenario",{method:"GET",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.body.getReader().read().then(function(e){var t=e;return null==t?Promise.reject():Promise.resolve(t)})})},fetchLobby:function(e){return window.fetch(c+"/api/lobbies/"+e,{method:"GET",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.body.getReader().read().then(function(e){var t=e;return null==t?Promise.reject():Promise.resolve(t)})})},fetchLobbies:function(){return window.fetch(c+"/api/lobbies",{method:"GET",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.json()})},openLobby:function(){return window.fetch(c+"/api/lobbies",{method:"POST",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded","session-id":u}}).then(function(e){return e.ok?(s.emit(t),Promise.resolve(e)):Promise.reject()})},joinLobby:function(e){return window.fetch(c+"/api/lobbies/"+e,{method:"POST",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded","session-id":u}}).then(function(e){return e.ok?(s.emit(n),Promise.resolve(e)):Promise.reject()})},pieceAPI:{getPieceCoordinates:function(){var e;return(e=new Headers({"session-id":u}),window.fetch(c+"/api/board",{method:"GET",mode:"cors",headers:e})).then(function(e){return e.body.getReader().read().then(function(e){var t=JSON.parse(new TextDecoder("utf-8").decode(e.value)),n=[];return t.pieces.forEach(function(e){Object.keys(n).includes(e.colour)||(n[e.colour]=[]),n[e.colour].push(new Reversi.Coords(e.position.x,e.position.y))}),Promise.resolve(n)})})}},fetchCurrentGame:function(){return window.fetch(c+"/api/game",{method:"GET",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded","session-id":u}}).then(function(e){return e.ok?e.json():Promise.reject()})},gameAPI:{startNewGame:function(t){var e=encodeURIComponent(t);return window.fetch(c+"/api/game",{method:"POST",mode:"cors",body:e,headers:{"Content-Type":"application/x-www-form-urlencoded","session-id":u}}).then(function(e){return e.ok?t:Promise.reject()})}}};return e}(),Reversi.LongPollDevice=function(){var r=void 0;return{init:function(){r=new Reversi.EventEmitter},watch:function(t,n){var e=function(){return(e=t,window.fetch(e,{headers:{Connection:"Keep-Alive"}})).then(r.emit(n));var e};r.subscribe(n,e),e()},subscribe:function(e,t){return r.subscribe(e,t)},unsubscribe:function(e,t){return r.unsubscribe(e,t)}}}(),Reversi.EventEmitter=function(){var r=[];this.subscribe=function(e,t){Object.keys(r).includes(e)||(r[e]=[]),r[e].push(t)},this.unsubscribe=function(e,t){if(Object.keys(r).includes(e)&&r[e].includes(t)){var n=r[e];n.splice(n.indexOf(t),1),r[e]=n}},this.emit=function(e){Object.keys(r).includes(e)&&r[e].forEach(function(e){return e.call()})}},Reversi.EventSubscriber=function(t,n){this.subscribe=function(e){return n.subscribe(t,e)},this.unsubscribe=function(e){return n.unsubscribe(t,e)}};var GameFactory=function(){var e=new Reversi.CellFactory,n=new Reversi.BoardFactory(e);return{fromScenario:function(e){var t=n.createBoard(e.boardSize.x,e.boardSize.y);return new Reversi.Game(t)}}}();function Notification(e,t,n){switch(e){case"positive":case"negative":this.type=e;break;default:case"neutral":this.type="neutral"}}Reversi.Game=function(e){var r=this,t=new Reversi.EventEmitter,n="state-updated";this.stateUpdated=new Reversi.EventSubscriber(n,t),this.updateState=function(){return Reversi.Data.pieceAPI.getPieceCoordinates().then(function(r){var i=[];return Object.keys(r).forEach(function(e){var n=new Reversi.PieceFactory(e),t=r[e];i.concat(t.forEach(function(e){var t=n.createPiece();t.position=e,i.push(t)}))}),i}).then(r.setPieces).then(function(){return t.emit(n)})};this.setPieces=function(e){!function(){for(;0<r.pieces.length;){var e=r.pieces.shift();r.despawnPiece(e)}}(),e.forEach(function(e){return r.spawnPiece(e,e.position)})},this.addPlayer=function(t){if(t.colour in r.players)throw new Error(t.colour+" already exists");r.players[t.colour()]=t,r.pieces.filter(function(e){return e.colour===t.colour()}).forEach(function(e){return t.pieces.push(e)})},this.getPlayerPieces=function(t){return r.pieces.filter(function(e){return e.colour===t.colour()})},this.spawnPiece=function(e,t){if(null==e||null==t)throw new Error("Invalid input");var n=r.board.cells[t];if(null!=n.occupant)throw new Error("Cell already occupied");e.position=t,n.occupant=e,r.pieces.push(e)},this.despawnPiece=function(e){r.board.cells[e.position].occupant=null,r.pieces.includes(e)&&r.pieces.splice(r.pieces.indexOf(e),1)},this.pieces=[],this.board=e,this.players=[],this.view=new Reversi.BoardSVG(this)},Reversi.Player=function(e,t){var n=this,r=new Reversi.EventEmitter,i="selection-changed";this.username=e,this.pieces=[];var o=t;this.colour=function(){return o},this.onSelectionChanged=new Reversi.EventSubscriber(i,r),this.selectPiece=function(e){n.deselectPiece(),(n.selectedPiece=e).select(),r.emit(i)},this.deselectPiece=function(){null!=n.selectedPiece&&(n.selectedPiece.deselect(),n.selectedPiece=null,r.emit(i))},this.ownsPiece=function(e){return null!=e&&n.colour()===e.colour}},Reversi.Scenario=function(e){var n=this;this.addPiece=function(e,t){null==n.startingPiecesCoords[e]&&(n.startingPiecesCoords[e]=[]),n.startingPiecesCoords[e].push(t)},this.addPlayer=function(e,t){n.players[t]=e},this.boardSize=e,this.startingPiecesCoords=[],this.players=[]},Reversi.BoardSVG=function(e){var r=this,t=new Reversi.EventEmitter,n="update",i=new Reversi.BoardElementFactory;this.element=i.createBoardElement(e.board.width,e.board.height,e.board.cells),this.pieces=[],this.cells=[],this.model=e,this.renderPiece=function(e){var t=e.position,n=i.createPieceElement(e);r.pieces[t]=n,r.element.appendChild(n)};var o=function(e){var t=i.createCellElement(e);r.cells[e.coords]=t,r.element.appendChild(t)};this.clear=function(){Object.keys(r.pieces).forEach(function(e){return r.element.removeChild(r.pieces[e])}),r.pieces=[]},this.render=function(){var t=[];Object.keys(r.model.board.cells).forEach(function(e){return t.push(r.model.board.cells[e])}),t.forEach(o),r.update()},this.updateInvoked={subscribe:function(e){return t.subscribe(n,e)},unsubscribe:function(e){return t.unsubscribe(n,e)}},this.update=function(){r.clear(),r.model.pieces.forEach(r.renderPiece),t.emit(n)}},Reversi.BoardElementFactory=function(){var c=this,s="http://www.w3.org/2000/svg";this.createPieceElement=function(t){var e=document.createElementNS(s,"circle"),n=new Reversi.Coords(t.position.x+.5,t.position.y+.5),r={r:4,style:"fill:"+t.colour,cx:10*n.x,cy:10*n.y};return e.addEventListener("click",function(e){e.preventDefault(),t.click()}),t.isSelected&&(r["stroke-width"]=".5",r.stroke="white"),Reversi.BoardElementFactory.SVGUtil.setAttributesNS(e,r),e},this.createCellElement=function(t){var e=document.createElementNS(s,"rect"),n={x:10*t.coords.x,y:10*t.coords.y,width:10,height:10,style:"fill:"+t.colour};return Reversi.BoardElementFactory.SVGUtil.setAttributesNS(e,n),e.addEventListener("click",function(e){e.preventDefault(),null!=t.onClick&&t.onClick()}),e.addEventListener("contextmenu",function(e){e.preventDefault(),null!=t.onRightClick&&t.onRightClick()}),e},this.createBoardElement=function(e,t,n){var r=document.createElementNS(s,"svg");n.map(function(e){var t=c.createCellElement(e);r.appendChild(t)});var i=10*e,o=10*t;return Reversi.BoardElementFactory.SVGUtil.setAttributesNS(r,{viewBox:"0 0 "+i+" "+o}),r}},Reversi.BoardElementFactory.SVGUtil=function(){var r=function(t){if(!(t instanceof Object))throw new Error("target not an Object");var n=[];return Object.keys(t).map(function(e){n[e]=t[e]}),n};return{objectToArray:r,setAttributesNS:function(e,t){if(!(e instanceof Element))throw new Error("target not an HTMLElement");if(t instanceof Object&&(t=r(t)),!(t instanceof Array))throw new Error("target not an Array");for(var n in t)e.setAttribute(n,t[n])}}}(),FeedbackWidget.Coords=function(e,t){this.x=e,this.y=t,this.toString=function(){return e+", "+t}},FeedbackWidget.Coords.parse=function(e){var t=e.split(","),n=2===t.length,r=!0;if(t.map(function(e){e=e.trim(),isNaN(Number(e))&&(r=!1)}),!n||!r)throw new Error("Incorrect input: "+e);var i=Number(t[0]),o=Number(t[1]);return new Coords(i,o)};